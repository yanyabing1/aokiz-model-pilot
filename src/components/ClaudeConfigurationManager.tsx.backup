'use client'

import { ClaudeConfig } from '@/lib/config'
import { message, Modal, notification, Tooltip } from 'antd'
import { useEffect, useState } from 'react'
import AdvancedFeatures from './AdvancedFeatures'
import ClaudeConfigurationFooter from './ClaudeConfigurationFooter'
import ClaudeConfigurationHeader from './ClaudeConfigurationHeader'
import LanguageSettings from './LanguageSettings'
import PrivacySettings from './PrivacySettings'
import UISettings from './UISettings'
import WorkspaceSettings from './WorkspaceSettings'

interface LegacyClaudeConfig {
  model: string
  max_tokens: number
  temperature: number
  top_p: number
  system_prompt: string
}

interface ClaudeCodeSettings {
  $schema?: string
  env?: {
    ANTHROPIC_AUTH_TOKEN?: string
    ANTHROPIC_BASE_URL?: string
    ANTHROPIC_MODEL?: string
  }
  feedbackSurveyState?: any
  claude_settings?: {
    max_tokens?: number
    temperature?: number
    top_p?: number
    system_prompt?: string
  }
}

export default function ClaudeConfigurationManager() {
  const [config, setConfig] = useState<ClaudeConfig>({
    model: 'glm-4.5',
    temperature: 0.7,
    max_tokens: 10000000,
    top_p: 0.9,
    system_prompt: `你是一个有帮助、尊重和诚实的助手。始终尽可能有帮助地回答，同时保持安全。你的回答不应包含任何有害、不道德、种族主义、性别歧视、有毒、危险或非法的内容。请确保你的回答在社会上是无偏见的，并且是积极的。
如果一个问题的含义不清楚或事实上不连贯，请解释为什么而不是回答不正确的内容。如果你不知道问题的答案，请不要分享虚假信息。`,
    theme: 'dark',
    auto_save: true,

    // API Settings
    api_endpoint: 'https://api.anthropic.com',
    anthropic_base_url: 'https://open.bigmodel.cn/api/anthropic',
    anthropic_auth_token: '',
    streaming: true,
    timeout: 30000,
    max_retries: 3,
    rate_limit: {
      requests_per_minute: 60,
      tokens_per_minute: 90000,
    },

    // Editor Settings
    editor_settings: {
      tab_size: 4,
      word_wrap: true,
      line_numbers: true,
      code_folding: true,
      font_size: 14,
      auto_completion: true,
      syntax_highlighting: true,
      minimap: true,
      bracket_matching: true,
      auto_indent: true,
    },

    // File & Workspace Settings
    file_exclusions: ['node_modules/**', '.git/**', '*.log', 'dist/**', 'build/**'],
    workspace_settings: {
      project_specific: true,
      multi_file_context: true,
      context_window: 200000,
      include_hidden_files: false,
      follow_symlinks: false,
    },

    // Language Settings
    language_settings: {
      javascript: {
        tab_size: 2,
        formatter: 'prettier',
        linter: 'eslint',
        auto_completion: true,
      },
      python: {
        tab_size: 4,
        formatter: 'black',
        linter: 'pylint',
        auto_completion: true,
      },
      typescript: {
        tab_size: 2,
        formatter: 'prettier',
        linter: 'eslint',
        auto_completion: true,
      },
    },

    // Privacy & Security
    privacy_settings: {
      data_retention_days: 30,
      disable_telemetry: false,
      disable_analytics: false,
      local_processing_only: false,
    },

    // Advanced Features
    custom_tools: {
      enabled: true,
      tool_paths: [],
      permissions: ['read', 'write', 'execute'],
    },

    // UI Settings
    ui_settings: {
      interface_density: 'comfortable',
      accent_color: '#165DFF',
      font_size: 14,
      show_line_numbers: true,
      show_minimap: true,
      word_wrap: true,
      notifications: {
        enabled: true,
        sound: true,
        desktop: false,
      },
    },
  })

  const [isLoading, setIsLoading] = useState(true)
  const [currentClaudeConfig, setCurrentClaudeConfig] = useState<LegacyClaudeConfig | null>(null)
  const [configStatus, setConfigStatus] = useState<'loading' | 'loaded' | 'error'>('loading')
  const [activeTab, setActiveTab] = useState('basic')
  const [showAuthToken, setShowAuthToken] = useState(false)
  const [configPreview, setConfigPreview] = useState<any>(null)
  const [showConfigPreview, setShowConfigPreview] = useState(false)

  useEffect(() => {
    loadClaudeConfig()
  }, [])

  const loadClaudeConfig = async () => {
    try {
      console.log('Loading Claude config...')
      const response = await fetch('/api/claude-config')
      console.log('Response status:', response.status)

      if (response.ok) {
        const claudeCodeSettings: ClaudeCodeSettings = await response.json()
        console.log('Loaded Claude config:', claudeCodeSettings)

        // 创建Legacy格式用于显示
        const legacyConfig: LegacyClaudeConfig = {
          model: claudeCodeSettings.env?.ANTHROPIC_MODEL || 'claude-3-5-sonnet-20241022',
          max_tokens: claudeCodeSettings.claude_settings?.max_tokens || 10000000,
          temperature: claudeCodeSettings.claude_settings?.temperature || 0.7,
          top_p: claudeCodeSettings.claude_settings?.top_p || 0.9,
          system_prompt: claudeCodeSettings.claude_settings?.system_prompt || '',
        }

        setCurrentClaudeConfig(legacyConfig)
        setConfig(prev => ({
          ...prev,
          model: legacyConfig.model,
          temperature: legacyConfig.temperature,
          max_tokens: legacyConfig.max_tokens,
          top_p: legacyConfig.top_p,
          system_prompt: legacyConfig.system_prompt || prev.system_prompt,
          anthropic_base_url:
            claudeCodeSettings.env?.ANTHROPIC_BASE_URL || 'https://open.bigmodel.cn/api/anthropic',
          anthropic_auth_token: claudeCodeSettings.env?.ANTHROPIC_AUTH_TOKEN || '',
        }))
        setConfigStatus('loaded')
      } else {
        console.error('Failed to load Claude config, status:', response.status)
        setConfigStatus('error')
      }
    } catch (error) {
      console.error('Failed to load Claude config:', error)
      setConfigStatus('error')
    } finally {
      setIsLoading(false)
    }
  }

  const saveClaudeConfig = async () => {
    try {
      // 构造Claude Code格式的配置
      const claudeCodeSettings: ClaudeCodeSettings = {
        $schema: 'https://json.schemastore.org/claude-code-settings.json',
        env: {
          ANTHROPIC_AUTH_TOKEN: config.anthropic_auth_token || '',
          ANTHROPIC_BASE_URL: config.anthropic_base_url || 'https://open.bigmodel.cn/api/anthropic',
          ANTHROPIC_MODEL: config.model || 'claude-3-5-sonnet-20241022',
        },
        claude_settings: {
          max_tokens: config.max_tokens || 10000000,
          temperature: config.temperature || 0.7,
          top_p: config.top_p || 0.9,
          system_prompt:
            config.system_prompt || 'You are Claude, an AI assistant created by Anthropic.',
        },
      }

      console.log('Saving Claude Code settings:', claudeCodeSettings)
      console.log('Current config state:', config)

      const response = await fetch('/api/claude-config', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(claudeCodeSettings),
      })

      console.log('Save response status:', response.status)
      const responseText = await response.text()
      console.log('Save response body:', responseText)

      if (response.ok) {
        notification.success({
          message: '保存成功',
          description: '配置已成功保存到 Claude 配置文件，请检查配置文件内容确认保存成功。',
          duration: 4,
        })
        // 重新加载配置以确保同步
        await loadClaudeConfig()
      } else {
        notification.error({
          message: '保存失败',
          description: `状态码: ${response.status}，响应: ${responseText}`,
          duration: 6,
        })
      }
    } catch (error) {
      console.error('Failed to save Claude config:', error)
      notification.error({
        message: '保存失败',
        description: `错误信息: ${error}，请检查网络连接和控制台日志`,
        duration: 6,
      })
    }
  }

  const testConfiguration = async () => {
    try {
      // 测试配置连接
      const testConfig = {
        anthropic_base_url: config.anthropic_base_url,
        anthropic_auth_token: config.anthropic_auth_token,
        model: config.model,
        timeout: config.timeout,
      }

      // 这里可以添加实际的API测试调用
      console.log('Testing configuration:', testConfig)

      // 模拟测试结果
      return {
        success: true,
        message: '配置测试成功',
        timestamp: new Date().toISOString(),
      }
    } catch (error) {
      return {
        success: false,
        message: `配置测试失败: ${error}`,
        timestamp: new Date().toISOString(),
      }
    }
  }

  const loadConfigPreview = async () => {
    try {
      const response = await fetch('/api/config')
      if (response.ok) {
        const fullConfig = await response.json()
        setConfigPreview(fullConfig)
      } else {
        // 如果无法从API加载，使用当前配置
        setConfigPreview(config)
      }
    } catch (error) {
      console.error('Failed to load config preview:', error)
      setConfigPreview(config)
    }
  }

  const handleConfigChange = (path: string, value: any) => {
    setConfig(prev => {
      const newConfig = { ...prev }
      const keys = path.split('.')
      let current: any = newConfig

      for (let i = 0; i < keys.length - 1; i++) {
        if (!current[keys[i]]) {
          current[keys[i]] = {}
        }
        current = current[keys[i]]
      }

      current[keys[keys.length - 1]] = value
      return newConfig
    })
  }

  const accentColors = ['#165DFF', '#0FC6C2', '#722ED1', '#22C55E', '#EAB308', '#EF4444', '#6B7280']

  const tabs = [
    { id: 'basic', label: '基础设置', icon: 'fas fa-cog' },
    { id: 'api', label: 'API设置', icon: 'fas fa-plug' },
    { id: 'editor', label: '编辑器', icon: 'fas fa-code' },
    { id: 'workspace', label: '工作空间', icon: 'fas fa-folder' },
    { id: 'languages', label: '语言设置', icon: 'fas fa-language' },
    { id: 'privacy', label: '隐私安全', icon: 'fas fa-shield-alt' },
    { id: 'advanced', label: '高级功能', icon: 'fas fa-rocket' },
    { id: 'ui', label: '界面设置', icon: 'fas fa-palette' },
  ]

  return (
    <div className="bg-dark min-h-screen font-inter text-light bg-grid overflow-x-hidden">
      {/* Background Elements */}
      <div className="fixed inset-0 -z-10 overflow-hidden">
        <div className="absolute top-1/4 left-1/4 w-64 h-64 rounded-full bg-primary/20 blur-3xl animate-pulse-slow"></div>
        <div
          className="absolute bottom-1/3 right-1/3 w-96 h-96 rounded-full bg-accent/20 blur-3xl animate-pulse-slow"
          style={{ animationDelay: '1s' }}
        ></div>
        <div
          className="absolute top-2/3 left-2/3 w-80 h-80 rounded-full bg-secondary/20 blur-3xl animate-pulse-slow"
          style={{ animationDelay: '2s' }}
        ></div>
      </div>

      {/* Header */}
      <ClaudeConfigurationHeader />

      {/* Main Content */}
      <main className="pt-32 pb-20 px-4 md:px-8 max-w-7xl mx-auto overflow-y-auto min-h-[calc(100vh-200px)]">
        {/* Two Column Layout */}
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Left Column - Tabs and Content (3/4 width) */}
          <div className="lg:col-span-3">
            {/* Tab Navigation */}
            <div className="mb-6 glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
              <div className="flex flex-wrap gap-2">
                {tabs.map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex items-center px-4 py-2 rounded-lg transition-all ${
                      activeTab === tab.id
                        ? 'bg-primary/20 text-primary border border-primary/50'
                        : 'bg-dark/50 text-gray-400 hover:text-white hover:bg-dark/70'
                    }`}
                  >
                    <i className={`${tab.icon} mr-2`}></i>
                    {tab.label}
                  </button>
                ))}
              </div>
            </div>
              {configStatus === 'loading' && (
                <div className="flex items-center text-yellow-500">
                  <i className="fas fa-spinner fa-spin mr-2"></i>
                  <span>加载中...</span>
                </div>
              )}
              {configStatus === 'loaded' && (
                <div className="flex items-center text-green-500">
                  <i className="fas fa-check-circle mr-2"></i>
                  <span>已加载</span>
                </div>
              )}
              {configStatus === 'error' && (
                <div className="flex items-center text-red-500">
                  <i className="fas fa-exclamation-circle mr-2"></i>
                  <span>加载失败</span>
                </div>
              )}
            </div>

          {/* Right Column - Current Config Sidebar (1/4 width) */}
          <div className="lg:col-span-1">
            {/* Current Config Status */}
            <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow sticky top-8">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center">
                  <div className="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center mr-2">
                    <i className="fas fa-file-alt text-primary text-sm"></i>
                  </div>
                  <h3 className="text-lg font-bold text-white">当前配置</h3>
                </div>
                <div className="flex items-center space-x-1">
                  {configStatus === 'loading' && (
                    <div className="flex items-center text-yellow-500 text-xs">
                      <i className="fas fa-spinner fa-spin mr-1"></i>
                      <span>加载中</span>
                    </div>
                  )}
                  {configStatus === 'loaded' && (
                    <div className="flex items-center text-green-500 text-xs">
                      <i className="fas fa-check-circle mr-1"></i>
                      <span>已加载</span>
                    </div>
                  )}
                  {configStatus === 'error' && (
                    <div className="flex items-center text-red-500 text-xs">
                      <i className="fas fa-exclamation-circle mr-1"></i>
                      <span>错误</span>
                    </div>
                  )}
                </div>
              </div>

              {currentClaudeConfig && (
                <div className="space-y-3">
                  <div className="bg-dark/50 rounded-lg p-3">
                    <div className="text-xs text-gray-400 mb-1">模型</div>
                    <div className="text-white text-sm font-medium truncate">{currentClaudeConfig.model}</div>
                  </div>
                  <div className="bg-dark/50 rounded-lg p-3">
                    <div className="text-xs text-gray-400 mb-1">温度</div>
                    <div className="text-white text-sm font-medium">{currentClaudeConfig.temperature}</div>
                  </div>
                  <div className="bg-dark/50 rounded-lg p-3">
                    <div className="text-xs text-gray-400 mb-1">最大令牌</div>
                    <div className="text-white text-sm font-medium">{currentClaudeConfig.max_tokens.toLocaleString()}</div>
                  </div>
                  <div className="bg-dark/50 rounded-lg p-3">
                    <div className="text-xs text-gray-400 mb-1">Top P</div>
                    <div className="text-white text-sm font-medium">{currentClaudeConfig.top_p}</div>
                  </div>
                </div>
              )}

              {!currentClaudeConfig && configStatus === 'loaded' && (
                <div className="text-yellow-400 text-xs">未找到配置数据</div>
              )}

              {configStatus === 'error' && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
                  <div className="flex items-center mb-2">
                    <i className="fas fa-exclamation-triangle text-red-400 mr-1 text-xs"></i>
                    <span className="text-red-400 font-medium text-xs">加载失败</span>
                  </div>
                  <div className="text-red-400 text-xs mb-2">
                    无法加载配置文件
                  </div>
                </div>
              )}

              {/* Configuration Status */}
              <div className="mt-4 pt-4 border-t border-gray-700">
                <h4 className="text-xs font-medium text-gray-300 mb-2">配置状态</h4>
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-400">认证令牌</span>
                    <div className={`flex items-center text-xs ${
                      config.anthropic_auth_token ? 'text-green-400' : 'text-red-400'
                    }`}>
                      <i className={`fas ${config.anthropic_auth_token ? 'fa-check' : 'fa-times'} mr-1`}></i>
                      {config.anthropic_auth_token ? '已设置' : '未设置'}
                    </div>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-400">API地址</span>
                    <div className={`flex items-center text-xs ${
                      config.anthropic_base_url ? 'text-green-400' : 'text-red-400'
                    }`}>
                      <i className={`fas ${config.anthropic_base_url ? 'fa-check' : 'fa-times'} mr-1`}></i>
                      {config.anthropic_base_url ? '已设置' : '未设置'}
                    </div>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-xs text-gray-400">系统提示</span>
                    <div className={`flex items-center text-xs ${
                      config.system_prompt ? 'text-green-400' : 'text-yellow-400'
                    }`}>
                      <i className={`fas ${config.system_prompt ? 'fa-check' : 'fa-exclamation'} mr-1`}></i>
                      {config.system_prompt ? '已设置' : '未设置'}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Configuration Completeness Check */}
        <div className="mt-4 p-4 bg-dark/30 rounded-lg border border-gray-700">
          <div className="flex items-center justify-between mb-3">
            <h4 className="text-sm font-medium text-gray-300">关键配置检查</h4>
            <div className="flex space-x-2">
              {config.anthropic_base_url && config.anthropic_auth_token ? (
                <div className="flex items-center text-green-400 text-xs">
                  <i className="fas fa-check-circle mr-1"></i>
                  <span>配置完整</span>
                </div>
              ) : (
                <div className="flex items-center text-yellow-400 text-xs">
                  <i className="fas fa-exclamation-triangle mr-1"></i>
                  <span>配置不完整</span>
                </div>
              )}
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div
              className={`flex items-center p-2 rounded text-xs ${
                config.anthropic_base_url
                  ? 'bg-green-500/10 text-green-400 border border-green-500/20'
                  : 'bg-red-500/10 text-red-400 border border-red-500/20'
              }`}
            >
              <i
                className={`fas ${config.anthropic_base_url ? 'fa-check' : 'fa-times'} mr-2`}
              ></i>
              <span>Base URL</span>
            </div>

            <div
              className={`flex items-center p-2 rounded text-xs ${
                config.anthropic_auth_token
                  ? 'bg-green-500/10 text-green-400 border border-green-500/20'
                  : 'bg-red-500/10 text-red-400 border border-red-500/20'
              }`}
            >
              <i
                className={`fas ${config.anthropic_auth_token ? 'fa-check' : 'fa-times'} mr-2`}
              ></i>
              <span>Auth Token</span>
            </div>

            <div
              className={`flex items-center p-2 rounded text-xs ${
                config.model
                  ? 'bg-green-500/10 text-green-400 border border-green-500/20'
                  : 'bg-red-500/10 text-red-400 border border-red-500/20'
              }`}
            >
              <i className={`fas ${config.model ? 'fa-check' : 'fa-times'} mr-2`}></i>
              <span>Model</span>
            </div>

            <div
              className={`flex items-center p-2 rounded text-xs ${
                config.system_prompt
                  ? 'bg-green-500/10 text-green-400 border border-green-500/20'
                  : 'bg-yellow-500/10 text-yellow-400 border border-yellow-500/20'
              }`}
            >
              <i
                className={`fas ${config.system_prompt ? 'fa-check' : 'fa-exclamation'} mr-2`}
              ></i>
              <span>System Prompt</span>
            </div>
          </div>

          {/* Configuration Issues Alert */}
          {(!config.anthropic_base_url || !config.anthropic_auth_token) && (
            <div className="mt-3 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
              <div className="flex items-center mb-2">
                <i className="fas fa-info-circle text-yellow-400 mr-2"></i>
                <span className="text-yellow-400 font-medium text-sm">配置建议</span>
              </div>
              <div className="text-yellow-300 text-xs space-y-1">
                {!config.anthropic_base_url && (
                  <div>
                    • 缺少 ANTHROPIC_BASE_URL，建议设置为: https://open.bigmodel.cn/api/anthropic
                  </div>
                )}
                {!config.anthropic_auth_token && (
                  <div>• 缺少 ANTHROPIC_AUTH_TOKEN，请在API设置中填入你的认证令牌</div>
                )}
                <div className="mt-2">
                  <button
                    onClick={() => setActiveTab('api')}
                    className="text-blue-400 hover:text-blue-300 underline text-xs"
                  >
                    点击这里前往API设置 →
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Basic Settings */}
        {activeTab === 'basic' && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            {/* Model Settings Card */}
            <div className="lg:col-span-1 glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow hover:shadow-glow-lg transition-all duration-500 transform hover:-translate-y-1">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center mr-3">
                  <i className="fas fa-brain text-primary"></i>
                </div>
                <h2 className="text-xl font-bold text-white">模型设置</h2>
              </div>
              <div className="space-y-6">
                {/* Model Selection */}
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">模型</label>
                  <div className="relative">
                    <select
                      className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 pr-10 text-light appearance-none focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                      value={config.model}
                      onChange={e => handleConfigChange('model', e.target.value)}
                    >
                      <optgroup label="Claude 4 系列">
                        <option value="claude-opus-4-20250514">
                          Claude Opus 4 - 最强大模型，混合推理
                        </option>
                        <option value="claude-sonnet-4-20250514">
                          Claude Sonnet 4 - 平衡性能与成本
                        </option>
                      </optgroup>
                      <optgroup label="Claude 3.x 系列">
                        <option value="claude-3-7-sonnet-20250219">
                          Claude Sonnet 3.7 - 扩展思考，128K输出
                        </option>
                        <option value="claude-3-5-sonnet-20241022">
                          Claude Sonnet 3.5 (新) - 支持计算机使用
                        </option>
                        <option value="claude-3-5-sonnet-20240620">
                          Claude Sonnet 3.5 (原) - 原始版本
                        </option>
                        <option value="claude-3-5-haiku-20241022">
                          Claude Haiku 3.5 - 高速高智能，实时应用
                        </option>
                        <option value="claude-3-haiku-20240307">Claude Haiku 3 - 最经济选择</option>
                      </optgroup>
                      <optgroup label="其他模型">
                        <option value="glm-4.5">GLM-4.5</option>
                        <option value="glm-4.5-air">GLM-4.5-Air</option>
                      </optgroup>
                    </select>
                    <div className="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                      <i className="fas fa-chevron-down text-primary/60"></i>
                    </div>
                  </div>
                </div>

                {/* Temperature */}
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <label className="block text-sm font-medium text-gray-300">Temperature</label>
                    <span className="text-sm text-primary">{config.temperature || 0.7}</span>
                  </div>
                  <div className="relative h-6 slider-track-bg rounded-full overflow-hidden">
                    <div
                      className="absolute left-0 top-0 slider-track"
                      style={{ width: `${(config.temperature || 0.7) * 100}%` }}
                    ></div>
                    <input
                      type="range"
                      min="0"
                      max="1"
                      step="0.01"
                      value={config.temperature || 0.7}
                      onChange={e => handleConfigChange('temperature', parseFloat(e.target.value))}
                      className="absolute left-0 top-0 w-full h-full appearance-none bg-transparent z-10"
                    />
                  </div>
                  <div className="flex justify-between text-xs text-gray-400 mt-1">
                    <span>精确</span>
                    <span>创意</span>
                  </div>
                </div>

                {/* Max Tokens */}
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">最大令牌数</label>
                  <div className="relative">
                    <input
                      type="number"
                      value={config.max_tokens || 10000000}
                      min="1"
                      max="10000000"
                      onChange={e => handleConfigChange('max_tokens', parseInt(e.target.value))}
                      className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light appearance-none focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                    />
                    <div className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                      <i className="fas fa-hashtag"></i>
                    </div>
                  </div>
                </div>

                {/* Top P */}
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <label className="block text-sm font-medium text-gray-300">Top P</label>
                    <span className="text-sm text-primary">{config.top_p || 0.9}</span>
                  </div>
                  <div className="relative h-6 slider-track-bg rounded-full overflow-hidden">
                    <div
                      className="absolute left-0 top-0 slider-track"
                      style={{ width: `${(config.top_p || 0.9) * 100}%` }}
                    ></div>
                    <input
                      type="range"
                      min="0"
                      max="1"
                      step="0.01"
                      value={config.top_p || 0.9}
                      onChange={e => handleConfigChange('top_p', parseFloat(e.target.value))}
                      className="absolute left-0 top-0 w-full h-full appearance-none bg-transparent z-10"
                    />
                  </div>
                  <div className="flex justify-between text-xs text-gray-400 mt-1">
                    <span>确定性</span>
                    <span>多样性</span>
                  </div>
                </div>
              </div>
            </div>

            {/* System Prompt Card */}
            <div className="lg:col-span-1 glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow hover:shadow-glow-lg transition-all duration-500 transform hover:-translate-y-1">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 rounded-lg bg-secondary/20 flex items-center justify-center mr-3">
                  <i className="fas fa-comment-dots text-secondary"></i>
                </div>
                <h2 className="text-xl font-bold text-white">系统提示</h2>
              </div>
              <div className="relative">
                <div className="absolute top-3 left-3 text-gray-400 text-xs">
                  <i className="fas fa-info-circle mr-1"></i>
                  使用系统指令指导 AI 行为
                </div>
                <textarea
                  className="w-full h-48 bg-dark/50 border border-secondary/40 rounded-lg p-4 pt-10 text-light font-mono text-sm focus:outline-none focus:ring-2 focus:ring-secondary/50 focus:border-secondary transition-all resize-none"
                  placeholder="在此输入系统提示..."
                  value={config.system_prompt || ''}
                  onChange={e => handleConfigChange('system_prompt', e.target.value)}
                />
              </div>
              <div className="flex justify-end mt-4">
                <button className="px-4 py-2 bg-secondary/20 hover:bg-secondary/30 text-secondary rounded-lg flex items-center transition-all duration-300">
                  <i className="fas fa-save mr-2"></i>
                  保存提示
                </button>
              </div>
            </div>

            {/* Save Configuration */}
            {/* <div className="lg:col-span-2 flex items-center justify-center mt-8">
              <button
                onClick={saveClaudeConfig}
                disabled={isLoading}
                className="px-8 py-4 bg-gradient-to-r from-primary to-accent text-white font-bold rounded-xl shadow-glow hover:shadow-glow-lg transition-all duration-300 transform hover:-translate-y-1 flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <i className="fas fa-save mr-2"></i>
                {isLoading ? '加载中...' : '保存到本地 Claude 配置'}
                <i className="fas fa-arrow-right ml-2"></i>
              </button>
            </div> */}
          </div>
        )}

        {/* API Settings */}
        {activeTab === 'api' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-plug text-primary mr-3"></i>
              API设置
            </h3>
            <div className="grid grid-cols-1 gap-6">
              {/* Anthropic Configuration - Highlighted Section */}
              <div className="bg-gradient-to-r from-primary/10 to-accent/10 border border-primary/30 rounded-xl p-6">
                <div className="flex items-center mb-4">
                  <div className="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center mr-3">
                    <i className="fas fa-key text-primary text-sm"></i>
                  </div>
                  <h4 className="text-lg font-bold text-white">Anthropic 核心配置</h4>
                  <div className="ml-2 px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded-full">
                    重要
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">
                      <i className="fas fa-globe mr-1"></i>
                      ANTHROPIC_BASE_URL
                    </label>
                    <input
                      type="text"
                      value={config.anthropic_base_url}
                      onChange={e => handleConfigChange('anthropic_base_url', e.target.value)}
                      placeholder="https://open.bigmodel.cn/api/anthropic"
                      className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                    />
                    <p className="text-xs text-gray-400 mt-1">Claude API的基础URL地址</p>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">
                      <i className="fas fa-shield-alt mr-1"></i>
                      ANTHROPIC_AUTH_TOKEN
                    </label>
                    <div className="relative">
                      <input
                        type={showAuthToken ? 'text' : 'password'}
                        value={config.anthropic_auth_token}
                        onChange={e => handleConfigChange('anthropic_auth_token', e.target.value)}
                        placeholder="输入你的认证令牌"
                        className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 pr-10 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                      />
                      <button
                        type="button"
                        onClick={() => setShowAuthToken(!showAuthToken)}
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-primary transition-colors"
                      >
                        <i className={`fas ${showAuthToken ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                      </button>
                    </div>
                    <p className="text-xs text-gray-400 mt-1">API访问认证令牌</p>
                  </div>
                </div>

                {/* Quick Setup Button */}
                <div className="flex justify-end mt-4">
                  <Tooltip title="自动填入推荐的API配置值">
                    <button
                      onClick={() => {
                        handleConfigChange(
                          'anthropic_base_url',
                          'https://open.bigmodel.cn/api/anthropic'
                        )
                        handleConfigChange(
                          'anthropic_auth_token',
                          '45150a6b55f24386b4e00ca3d60a1264.LBYrMMJ292Jz5O08'
                        )
                        message.success('已设置推荐配置')
                        notification.info({
                          message: '快速配置完成',
                          description:
                            '已设置推荐的配置值，请点击"保存配置"按钮保存到Claude配置文件。',
                          duration: 4,
                        })
                      }}
                      className="px-4 py-2 bg-gradient-to-r from-green-500/20 to-green-600/20 text-green-400 border border-green-500/30 rounded-lg hover:from-green-500/30 hover:to-green-600/30 transition-all duration-300 text-sm flex items-center"
                    >
                      <i className="fas fa-magic mr-2"></i>
                      快速配置推荐值
                    </button>
                  </Tooltip>
                </div>
              </div>

              {/* Other API Settings */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    标准API端点
                  </label>
                  <input
                    type="text"
                    value={config.api_endpoint}
                    onChange={e => handleConfigChange('api_endpoint', e.target.value)}
                    className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                  />
                  <p className="text-xs text-gray-400 mt-1">备用API端点地址</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    超时时间 (ms)
                  </label>
                  <input
                    type="number"
                    value={config.timeout}
                    onChange={e => handleConfigChange('timeout', parseInt(e.target.value))}
                    className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                  />
                  <p className="text-xs text-gray-400 mt-1">API请求超时时间</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    最大重试次数
                  </label>
                  <input
                    type="number"
                    value={config.max_retries}
                    onChange={e => handleConfigChange('max_retries', parseInt(e.target.value))}
                    className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                  />
                  <p className="text-xs text-gray-400 mt-1">失败时重试次数</p>
                </div>

                <div className="flex items-center justify-between p-4 bg-dark/30 rounded-lg">
                  <div>
                    <label className="text-sm font-medium text-gray-300 flex items-center">
                      <i className="fas fa-stream mr-2"></i>
                      流式响应
                    </label>
                    <p className="text-xs text-gray-400 mt-1">启用实时响应流</p>
                  </div>
                  <label className="toggle-switch">
                    <input
                      type="checkbox"
                      checked={config.streaming}
                      onChange={e => handleConfigChange('streaming', e.target.checked)}
                    />
                    <span className="toggle-slider"></span>
                  </label>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    每分钟请求限制
                  </label>
                  <input
                    type="number"
                    value={config.rate_limit?.requests_per_minute || 60}
                    onChange={e =>
                      handleConfigChange('rate_limit.requests_per_minute', parseInt(e.target.value))
                    }
                    className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                  />
                  <p className="text-xs text-gray-400 mt-1">API速率限制配置</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    每分钟令牌限制
                  </label>
                  <input
                    type="number"
                    value={config.rate_limit?.tokens_per_minute || 90000}
                    onChange={e =>
                      handleConfigChange('rate_limit.tokens_per_minute', parseInt(e.target.value))
                    }
                    className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                  />
                  <p className="text-xs text-gray-400 mt-1">令牌使用速率限制</p>
                </div>
              </div>

              {/* Configuration Actions */}
              <div className="flex flex-col sm:flex-row gap-4 mt-6 pt-6 border-t border-gray-700">
                <Tooltip title="测试当前API配置的连接状态">
                  <button
                    onClick={async () => {
                      const result = await testConfiguration()
                      if (result.success) {
                        message.success(result.message)
                        notification.success({
                          message: '连接测试成功',
                          description: '配置验证通过，连接正常',
                          duration: 3,
                        })
                      } else {
                        message.error(result.message)
                        notification.error({
                          message: '连接测试失败',
                          description: result.message,
                          duration: 5,
                        })
                      }
                    }}
                    className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500/20 to-blue-600/20 text-blue-400 border border-blue-500/30 rounded-lg hover:from-blue-500/30 hover:to-blue-600/30 transition-all duration-300 flex items-center justify-center"
                  >
                    <i className="fas fa-plug mr-2"></i>
                    测试配置连接
                  </button>
                </Tooltip>

                <Tooltip title="查看完整的配置文件内容">
                  <button
                    onClick={() => {
                      loadConfigPreview()
                      setShowConfigPreview(true)
                    }}
                    className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500/20 to-purple-600/20 text-purple-400 border border-purple-500/30 rounded-lg hover:from-purple-500/30 hover:to-purple-600/30 transition-all duration-300 flex items-center justify-center"
                  >
                    <i className="fas fa-eye mr-2"></i>
                    查看完整配置
                  </button>
                </Tooltip>

                <Tooltip title="显示当前配置的调试信息">
                  <button
                    onClick={() => {
                      console.log('=== 调试信息 ===')
                      console.log('当前界面配置:', config)
                      console.log('ANTHROPIC_BASE_URL:', config.anthropic_base_url)
                      console.log(
                        'ANTHROPIC_AUTH_TOKEN:',
                        config.anthropic_auth_token ? '已设置' : '未设置'
                      )
                      console.log('Model:', config.model)

                      const debugInfo = `ANTHROPIC_BASE_URL: ${config.anthropic_base_url || '未设置'}
ANTHROPIC_AUTH_TOKEN: ${config.anthropic_auth_token ? '已设置' : '未设置'}
Model: ${config.model}`

                      Modal.info({
                        title: '调试信息',
                        content: (
                          <div className="font-mono whitespace-pre-line text-sm">{debugInfo}</div>
                        ),
                        okText: '确定',
                        width: 500,
                      })

                      message.info('调试信息已输出到控制台')
                    }}
                    className="px-4 py-3 bg-gradient-to-r from-orange-500/20 to-orange-600/20 text-orange-400 border border-orange-500/30 rounded-lg hover:from-orange-500/30 hover:to-orange-600/30 transition-all duration-300 flex items-center justify-center"
                  >
                    <i className="fas fa-bug mr-2"></i>
                    调试信息
                  </button>
                </Tooltip>
              </div>
            </div>
          </div>
        )}

        {/* Configuration Preview Modal */}
        {showConfigPreview && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-dark border border-primary/30 rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden shadow-2xl">
              <div className="flex items-center justify-between p-6 border-b border-gray-700">
                <div className="flex items-center">
                  <div className="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center mr-3">
                    <i className="fas fa-code text-purple-400"></i>
                  </div>
                  <h3 className="text-xl font-bold text-white">完整配置预览</h3>
                </div>
                <button
                  onClick={() => setShowConfigPreview(false)}
                  className="w-8 h-8 rounded-lg bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-gray-400 hover:text-white transition-colors"
                >
                  <i className="fas fa-times"></i>
                </button>
              </div>

              <div className="p-6 overflow-y-auto max-h-[60vh]">
                <div className="bg-dark/50 rounded-lg p-4 border border-gray-700">
                  <pre className="text-sm text-gray-300 whitespace-pre-wrap font-mono overflow-x-auto">
                    {configPreview
                      ? JSON.stringify(configPreview, null, 2)
                      : JSON.stringify(config, null, 2)}
                  </pre>
                </div>

                <div className="mt-4 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                  <div className="flex items-center mb-2">
                    <i className="fas fa-info-circle text-yellow-400 mr-2"></i>
                    <span className="text-yellow-400 font-medium">配置信息</span>
                  </div>
                  <ul className="text-sm text-gray-300 space-y-1">
                    <li>
                      • <strong>ANTHROPIC_BASE_URL:</strong> {config.anthropic_base_url || '未设置'}
                    </li>
                    <li>
                      • <strong>ANTHROPIC_AUTH_TOKEN:</strong>{' '}
                      {config.anthropic_auth_token ? '已设置 (***隐藏***)' : '未设置'}
                    </li>
                    <li>
                      • <strong>当前模型:</strong> {config.model}
                    </li>
                    <li>
                      • <strong>温度:</strong> {config.temperature}
                    </li>
                    <li>
                      • <strong>最大令牌:</strong> {config.max_tokens}
                    </li>
                    <li>
                      • <strong>Top P:</strong> {config.top_p}
                    </li>
                  </ul>
                </div>
              </div>

              <div className="p-6 border-t border-gray-700 flex justify-end space-x-3">
                <button
                  onClick={() => {
                    navigator.clipboard.writeText(JSON.stringify(configPreview || config, null, 2))
                    message.success('配置已复制到剪贴板')
                  }}
                  className="px-4 py-2 bg-green-500/20 text-green-400 border border-green-500/30 rounded-lg hover:bg-green-500/30 transition-colors flex items-center"
                >
                  <i className="fas fa-copy mr-2"></i>
                  复制配置
                </button>
                <button
                  onClick={() => setShowConfigPreview(false)}
                  className="px-4 py-2 bg-gray-500/20 text-gray-400 border border-gray-500/30 rounded-lg hover:bg-gray-500/30 transition-colors"
                >
                  关闭
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Editor Settings */}
        {activeTab === 'editor' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-code text-primary mr-3"></i>
              编辑器设置
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">制表符大小</label>
                <input
                  type="number"
                  value={config.editor_settings?.tab_size || 4}
                  onChange={e =>
                    handleConfigChange('editor_settings.tab_size', parseInt(e.target.value))
                  }
                  className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">字体大小</label>
                <input
                  type="number"
                  value={config.editor_settings?.font_size || 14}
                  onChange={e =>
                    handleConfigChange('editor_settings.font_size', parseInt(e.target.value))
                  }
                  className="w-full bg-dark/50 border border-primary/40 rounded-lg py-3 px-4 text-light"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">自动换行</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.word_wrap || false}
                  onChange={e => handleConfigChange('editor_settings.word_wrap', e.target.checked)}
                  className="toggle"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">行号</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.line_numbers || false}
                  onChange={e =>
                    handleConfigChange('editor_settings.line_numbers', e.target.checked)
                  }
                  className="toggle"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">代码折叠</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.code_folding || false}
                  onChange={e =>
                    handleConfigChange('editor_settings.code_folding', e.target.checked)
                  }
                  className="toggle"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">自动补全</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.auto_completion || false}
                  onChange={e =>
                    handleConfigChange('editor_settings.auto_completion', e.target.checked)
                  }
                  className="toggle"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">语法高亮</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.syntax_highlighting || false}
                  onChange={e =>
                    handleConfigChange('editor_settings.syntax_highlighting', e.target.checked)
                  }
                  className="toggle"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">小地图</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.minimap || false}
                  onChange={e => handleConfigChange('editor_settings.minimap', e.target.checked)}
                  className="toggle"
                />
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium text-gray-300">括号匹配</label>
                <input
                  type="checkbox"
                  checked={config.editor_settings?.bracket_matching || false}
                  onChange={e =>
                    handleConfigChange('editor_settings.bracket_matching', e.target.checked)
                  }
                  className="toggle"
                />
              </div>
            </div>
          </div>
        )}

        {/* Workspace Settings */}
        {activeTab === 'workspace' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-folder text-primary mr-3"></i>
              工作空间设置
            </h3>
            <WorkspaceSettings config={config} onConfigChange={handleConfigChange} />
          </div>
        )}

        {/* Language Settings */}
        {activeTab === 'languages' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-language text-primary mr-3"></i>
              语言设置
            </h3>
            <LanguageSettings config={config} onConfigChange={handleConfigChange} />
          </div>
        )}

        {/* Privacy Settings */}
        {activeTab === 'privacy' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-shield-alt text-primary mr-3"></i>
              隐私与安全设置
            </h3>
            <PrivacySettings config={config} onConfigChange={handleConfigChange} />
          </div>
        )}

        {/* Advanced Features */}
        {activeTab === 'advanced' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-rocket text-primary mr-3"></i>
              高级功能
            </h3>
            <AdvancedFeatures config={config} onConfigChange={handleConfigChange} />
          </div>
        )}

        {/* UI Settings */}
        {activeTab === 'ui' && (
          <div className="glass-dark rounded-2xl p-6 border border-primary/30 shadow-glow">
            <h3 className="text-xl font-bold text-white mb-6 flex items-center">
              <i className="fas fa-palette text-primary mr-3"></i>
              界面设置
            </h3>
            <UISettings config={config} onConfigChange={handleConfigChange} />
          </div>
        )}

        <div className="h-40 flex justify-center mt-8"></div>
      </div>
      </main>

      {/* Footer */}
      <ClaudeConfigurationFooter onSave={saveClaudeConfig} isLoading={isLoading} />
    </div>
  )
}
